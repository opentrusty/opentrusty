name: Publish API Docs

on:
  workflow_run:
    workflows: ["Release Gate"]
    types:
      - completed

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  docs:
    runs-on: ubuntu-latest
    # Only run if Release Gate succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Check Release Gate Status
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "‚ùå Release Gate workflow did not succeed. Documentation will not be published."
            echo "Release Gate Status: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          fi
          echo "‚úÖ Release Gate passed. Proceeding with documentation publication."

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Install Swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate OpenAPI Spec
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          make docs-gen
          # Inject version and host into swagger.json
          VERSION=${GITHUB_REF_NAME}
          sed -i "s/DOCS_VERSION_PLACEHOLDER/${VERSION}/g" docs/api/swagger.json
          sed -i 's/"host": "api.opentrusty.org"/"host": "docs.opentrusty.org"/g' docs/api/swagger.json

      - name: Checkout Documentation History
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: public_history
          fetch-depth: 0
        continue-on-error: true # Allow failure if branch doesn't exist yet

      - name: Build Premium Documentation Portal
        run: |
          export DOCS_VERSION=${GITHUB_REF_NAME}
          mkdir -p build_output
          if [ -d "public_history/versions" ]; then
            # Extract list of versions, add current one, sort and uniq
            EXISTING=$(ls public_history/versions | paste -sd "," -)
            export ALL_VERSIONS="${EXISTING},${GITHUB_REF_NAME}"
          else
            export ALL_VERSIONS="${GITHUB_REF_NAME}"
          fi
          node scripts/build-docs-site.js
          # Move site artifacts to build_output
          cp -r build_docs/* build_output/

      - name: Verify Documentation Build
        run: |
          if [ ! -f "build_output/index.html" ]; then
            echo "‚ùå Documentation build failed: index.html not found"
            exit 1
          fi
          if [ ! -f "build_output/api/index.html" ]; then
            echo "‚ùå Documentation build failed: API reference not generated"
            exit 1
          fi
          echo "‚úÖ Documentation build verified successfully"

      - name: Prepare Deployment Directory
        run: |
          # If public_history doesn't exist (fresh repo), create it
          if [ ! -d "public_history" ]; then
            mkdir public_history
            cd public_history
            git init
            git checkout -b gh-pages
            cd ..
          fi
          
          VERSION=${GITHUB_REF_NAME}
          TARGET_DIR="public_history/versions/$VERSION"
          
          # Remove existing version if re-running tag
          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          
          # Copy new build artifacts (HTML portal + API spec)
          cp -r build_output/* "$TARGET_DIR/"
          # Copy openapi.json to the root of the version so Redoc can find it
          cp docs/api/swagger.json "$TARGET_DIR/openapi.json"

      - name: Update Index and Persist History
        run: |
          # Rebuild the root index.html
          ./scripts/generate-docs-index.sh "public_history"
          
          cd public_history
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          git commit -m "Deploy API Docs for ${GITHUB_REF_NAME}"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:gh-pages --force

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "public_history"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Documentation Deployment Complete
        run: |
          echo "‚úÖ Documentation successfully published to docs.opentrusty.org"
          echo "üìö Version: ${GITHUB_REF_NAME}"
          echo "üåê URL: https://docs.opentrusty.org/versions/${GITHUB_REF_NAME}/"
