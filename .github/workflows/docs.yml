name: Publish API Docs

on:
  workflow_run:
    workflows: ["Release Gate"]
    types:
      - completed

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read # Required to download artifacts from another workflow run

jobs:
  docs:
    runs-on: ubuntu-latest
    # Only run if Release Gate succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Check Release Gate Status
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "‚ùå Release Gate workflow did not succeed. Documentation will not be published."
            exit 1
          fi
          echo "‚úÖ Release Gate passed. Proceeding with documentation publication."

      - name: Detect Version and Level
        id: info
        run: |
          # Use head_branch as it contains the tag for tag-triggered workflows
          VERSION="${{ github.event.workflow_run.head_branch }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Detect level using script
          # We need to checkout briefly or just assume we have the script? 
          # Better to checkout first.
          echo "‚úÖ Detected Version: $VERSION"

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Identify Maturity Level
        id: level
        run: |
          VERSION="${{ steps.info.outputs.version }}"
          # Fallback if VERSION is empty or not a tag
          if [[ ! "$VERSION" =~ ^v[0-9] ]]; then
            echo "level=ga" >> $GITHUB_OUTPUT
            exit 0
          fi
          LEVEL=$(./scripts/detect-release-level.sh "$VERSION")
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "‚úÖ Maturity Level: $LEVEL"

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Install Swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate OpenAPI Spec
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          make docs-gen
          # Inject version and host into swagger.json
          VERSION="${{ steps.info.outputs.version }}"
          sed -i "s/DOCS_VERSION_PLACEHOLDER/${VERSION}/g" docs/api/swagger.json
          sed -i 's/"host": "api.opentrusty.org"/"host": "docs.opentrusty.org"/g' docs/api/swagger.json

      - name: Checkout Documentation History
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: public_history
          fetch-depth: 0
        continue-on-error: true

      - name: Download test reports from Release Gate
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          path: reports_download
          github-token: ${{ github.token }}
        continue-on-error: true

      - name: Prepare reports for build
        run: |
          mkdir -p reports_download
          mkdir -p docs/testing
          
          echo "üìÇ Discovery: Finding and copying reports..."
          # v4 download preserves names if multiple artifacts are downloaded.
          # We search recursively within the download path.
          find reports_download -name "ut-report.md" -exec cp {} docs/testing/ut-report.md \;
          find reports_download -name "st-report.md" -exec cp {} docs/testing/st-report.md \;
          find reports_download -name "e2e-report.md" -exec cp {} docs/testing/e2e-report.md \;
          
          echo "‚úÖ Preparation Status:"
          [ -f "docs/testing/ut-report.md" ] && echo "  - UT: OK" || echo "  - UT: Missing"
          [ -f "docs/testing/st-report.md" ] && echo "  - ST: OK" || echo "  - ST: Missing"
          [ -f "docs/testing/e2e-report.md" ] && echo "  - E2E: OK" || echo "  - E2E: Missing"

      - name: Build Premium Documentation Portal
        run: |
          export DOCS_VERSION="${{ steps.info.outputs.version }}"
          echo "üî® Building portal for version: $DOCS_VERSION"
          
          rm -rf build_output build_docs
          mkdir -p build_output build_docs
          
          if [ -d "public_history/versions" ]; then
            EXISTING=$(ls public_history/versions | paste -sd "," -)
            export ALL_VERSIONS="${EXISTING},${DOCS_VERSION}"
          else
            export ALL_VERSIONS="${DOCS_VERSION}"
          fi
          
          node scripts/build-docs-site.js
          cp -r build_docs/* build_output/

      - name: Verify Documentation Build
        run: |
          if [ ! -f "build_output/index.html" ]; then
            echo "‚ùå Documentation build failed: index.html not found"
            exit 1
          fi
          
          REPORT_COUNT=$(find build_output -name "*report.html" | wc -l)
          echo "üìä Found $REPORT_COUNT test report files in build_output"
          
          if [ "$REPORT_COUNT" -eq 0 ]; then
             echo "‚ö†Ô∏è  Warning: No test reports found in build_output. This will cause 404s."
          fi
          
          echo "‚úÖ Documentation build verified successfully"

      - name: Prepare Deployment Directory
        run: |
          if [ ! -d "public_history" ]; then
            mkdir public_history
            cd public_history
            git init
            git checkout -b gh-pages
            cd ..
          fi
          
          VERSION="${{ steps.info.outputs.version }}"
          TARGET_DIR="public_history/versions/$VERSION"
          
          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          
          cp -r build_output/* "$TARGET_DIR/"
          cp docs/api/swagger.json "$TARGET_DIR/openapi.json"

      - name: Update Index and Persist History
        run: |
          VERSION="${{ steps.info.outputs.version }}"
          LEVEL="${{ steps.level.outputs.level }}"
          
          # Rebuild the root index.html
          ./scripts/generate-docs-index.sh "public_history"
          
          cd public_history
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # CRITICAL: Explicitly remove any .gitignore that might exist on the gh-pages branch
          # this ensures that even if it's there from a previous commit, it's gone now.
          rm -f .gitignore
          
          git add .
          git commit -m "Deploy API Docs for $VERSION" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:gh-pages --force

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "public_history"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Documentation Deployment Complete
        run: |
          echo "‚úÖ Documentation successfully published to docs.opentrusty.org"
          echo "üìö Version: ${GITHUB_REF_NAME}"
          echo "üåê URL: https://docs.opentrusty.org/versions/${GITHUB_REF_NAME}/"
