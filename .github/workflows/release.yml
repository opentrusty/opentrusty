name: Release Gate

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  detect-level:
    name: Detect Release Level
    runs-on: ubuntu-latest
    outputs:
      level: ${{ steps.detect.outputs.level }}
      is_tag: ${{ steps.detect.outputs.is_tag }}
      is_pr: ${{ steps.detect.outputs.is_pr }}
      require_integration: ${{ steps.detect.outputs.require_integration }}
      require_e2e: ${{ steps.detect.outputs.require_e2e }}
      require_systemd: ${{ steps.detect.outputs.require_systemd }}
      require_security: ${{ steps.detect.outputs.require_security }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Detect maturity level and gates
        id: detect
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "level=ga" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "require_integration=true" >> $GITHUB_OUTPUT
            echo "require_e2e=true" >> $GITHUB_OUTPUT
            echo "require_systemd=true" >> $GITHUB_OUTPUT
            echo "require_security=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Triggered by PR: Defaulting to Full Gates"
          else
            LEVEL=$(./scripts/detect-release-level.sh "${{ github.ref_name }}")
            echo "level=$LEVEL" >> $GITHUB_OUTPUT
            echo "is_tag=${{ github.ref_type == 'tag' }}" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
            
            # Default gates
            RI="false"; RE2E="false"; RS="false"; RSEC="false"
            
            case "$LEVEL" in
              alpha) RI="false"; RE2E="false"; RS="false"; RSEC="false" ;;
              beta)  RI="true";  RE2E="true";  RS="false"; RSEC="false" ;;
              rc|ga) RI="true";  RE2E="true";  RS="true";  RSEC="true"  ;;
            esac
            
            echo "require_integration=$RI" >> $GITHUB_OUTPUT
            echo "require_e2e=$RE2E" >> $GITHUB_OUTPUT
            echo "require_systemd=$RS" >> $GITHUB_OUTPUT
            echo "require_security=$RSEC" >> $GITHUB_OUTPUT
            echo "‚úÖ Level: $LEVEL (Integration:$RI E2E:$RE2E Systemd:$RS Security:$RSEC)"
          fi


  checklist-validation:
    name: Release Checklist Validation (REQUIRED)
    runs-on: ubuntu-latest
    needs: detect-level
    if: needs.detect-level.outputs.is_tag == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validate release checklist
        run: |
          LEVEL="${{ needs.detect-level.outputs.level }}"
          ./scripts/validate-release-checklist.sh "$GITHUB_REF_NAME" "$LEVEL"
          echo "‚úÖ Release checklist validated for $LEVEL release"

  api-docs-freshness:
    name: API Documentation Freshness (REQUIRED)
    runs-on: ubuntu-latest
    needs: detect-level
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Install Swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Check API docs freshness
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          ./scripts/check-docs.sh
          echo "‚úÖ API documentation is fresh and in sync with code"

  unit-tests:
    name: Unit Tests (REQUIRED)
    runs-on: ubuntu-latest
    needs: detect-level
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Run unit tests with report
        run: make test-report-ut

      - name: Upload UT reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ut-reports
          path: artifacts/tests/ut-*
          retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-level, unit-tests]
    if: needs.detect-level.outputs.require_integration == 'true' || needs.detect-level.outputs.is_tag == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run integration tests with report
        run: make test-report-st

      - name: Upload ST reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: st-reports
          path: artifacts/tests/st-*
          retention-days: 7

  docker-e2e:
    name: Docker E2E Tests
    needs: [detect-level, unit-tests]
    runs-on: ubuntu-latest
    if: needs.detect-level.outputs.require_e2e == 'true' || needs.detect-level.outputs.is_tag == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run E2E tests with report
        run: make test-report-e2e

      - name: Upload E2E reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-reports
          path: artifacts/tests/e2e-*
          retention-days: 7

      - name: Capture Docker logs on failure
        if: failure()
        run: |
          mkdir -p logs
          docker compose -f tests/e2e/docker/docker-compose.test.yml logs > logs/docker-e2e.log
        continue-on-error: true

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-e2e-logs
          path: logs/

  systemd-smoke:
    name: Systemd Smoke Test
    needs: [detect-level, docker-e2e]
    runs-on: ubuntu-latest
    if: needs.detect-level.outputs.require_systemd == 'true' || needs.detect-level.outputs.is_tag == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run systemd smoke test
        run: make test-systemd

      - name: Capture systemd logs on failure
        if: failure()
        run: |
          mkdir -p logs
          docker exec opentrusty-systemd journalctl -u opentrusty --no-pager > logs/systemd-journal.log || true
        continue-on-error: true

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: systemd-smoke-logs
          path: logs/

  security-scan:
    name: Security Scan
    needs: [detect-level, unit-tests]
    runs-on: ubuntu-latest
    if: needs.detect-level.outputs.require_security == 'true' || needs.detect-level.outputs.is_tag == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif

  release-gate-complete:
    name: Release Gate Complete
    runs-on: ubuntu-latest
    needs: [detect-level, checklist-validation, api-docs-freshness, unit-tests, integration-tests, docker-e2e, systemd-smoke, security-scan]
    if: always()
    steps:
      - name: Check all required gates passed
        run: |
          LEVEL="${{ needs.detect-level.outputs.level }}"
          IS_TAG="${{ needs.detect-level.outputs.is_tag }}"
          
          # Check checklist validation (only for tags)
          if [[ "$IS_TAG" == "true" ]]; then
            if [[ "${{ needs.checklist-validation.result }}" != "success" ]]; then
              echo "‚ùå Release Checklist Validation failed"
              exit 1
            fi
          fi
          
          # All these are now required for both PRs and tags as per "full release gates"
          
          if [[ "${{ needs.api-docs-freshness.result }}" != "success" ]]; then
            echo "‚ùå API Documentation Freshness check failed"
            exit 1
          fi
          
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "‚ùå Unit Tests failed"
            exit 1
          fi
          
          # Check conditional gates
          if [[ "${{ needs.detect-level.outputs.require_integration }}" == "true" ]]; then
            if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
              echo "‚ùå Integration Tests failed (Required for $LEVEL)"
              exit 1
            fi
          fi
          
          if [[ "${{ needs.detect-level.outputs.require_e2e }}" == "true" ]]; then
            if [[ "${{ needs.docker-e2e.result }}" != "success" ]]; then
              echo "‚ùå Docker E2E Tests failed (Required for $LEVEL)"
              exit 1
            fi
          fi
          
          if [[ "${{ needs.detect-level.outputs.require_systemd }}" == "true" ]]; then
            if [[ "${{ needs.systemd-smoke.result }}" != "success" ]]; then
              echo "‚ùå Systemd Smoke Test failed (Required for $LEVEL)"
              exit 1
            fi
          fi
          
          if [[ "${{ needs.detect-level.outputs.require_security }}" == "true" ]]; then
            if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
              echo "‚ùå Security Scan failed (Required for $LEVEL)"
              exit 1
            fi
          fi
          
          echo "‚úÖ All required release gates passed for $LEVEL"
          if [[ "$IS_TAG" == "true" ]]; then
            echo "üéâ Release $GITHUB_REF_NAME is ready for publication"
          else
            echo "‚úÖ Pull Request is ready for merge"
          fi
