name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Unit Tests (UT) - Fast feedback loop
  test-ut:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run unit tests with report
        # Standardizes on 'make test-report-ut' which handles JSON + MD generation
        run: make test-report-ut

      - name: Upload UT reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ut-reports
          path: artifacts/tests/ut-*
          retention-days: 14

  # 2. System Tests (ST) - Requires active PostgreSQL
  test-st:
    name: System Tests
    needs: test-ut
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: opentrusty
          POSTGRES_PASSWORD: opentrusty_dev_password
          POSTGRES_DB: opentrusty
        ports:
          - 5432:5432
        # Use health checks to wait for PG to be ready
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run system tests with report
        # Uses standard 'make test-report-st'
        run: make test-report-st

      - name: Upload ST reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: st-reports
          path: artifacts/tests/st-*
          retention-days: 14

  # 3. E2E Tests - Full Docker environment
  test-e2e:
    name: Docker E2E Tests
    # Only run E2E on main merge or tags to save CI time, 
    # but could be run on PRs if requested.
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    needs: test-st
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run E2E tests with report
        run: make test-report-e2e

      - name: Upload E2E reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-reports
          path: artifacts/tests/e2e-*
          retention-days: 14

      - name: Capture Docker logs on failure
        if: failure()
        run: |
          mkdir -p logs
          docker compose -f tests/e2e/docker/docker-compose.test.yml logs > logs/docker-e2e.log
        continue-on-error: true

  # 4. Mandatory Promotion Gate
  # This job acts as a final collector that MUST pass for the PR/Release to be considered valid.
  promotion-gate:
    name: Promotion Gate
    needs: [test-ut, test-st, test-e2e]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check Status
        # Fails the gate if any required test job failed
        run: |
          if [[ "${{ needs.test-ut.result }}" != "success" ]] || \
             [[ "${{ needs.test-st.result }}" != "success" ]] || \
             [[ "${{ needs.test-e2e.result }}" != "success" ]]; then
            echo "âŒ CI Hardening Failure: One or more required test suites failed."
            exit 1
          fi
          echo "âœ… All mandatory test gates passed."

      - name: Consolidate Reports
        # Downloads artifacts to ensure they are available for downstream or manual review
        uses: actions/download-artifact@v4
        with:
          path: artifacts/tests

  # 5. Documentation Publication Gate
  # This job depends on the promotion gate and publishes the documentation site,
  # including versioned test reports.
  publish-docs:
    name: Publish Documentation
    needs: promotion-gate
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Download all test reports
        uses: actions/download-artifact@v4
        with:
          path: artifacts/tests

      - name: Extract Version
        id: version
        # Extract version from tag (v1.0.0-rc.1) or use 'latest' for main
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare versioned docs
        # Create directory structure for versioned releases
        run: |
           VERSION=${{ steps.version.outputs.version }}
           if [[ "$VERSION" != "latest" ]]; then
             mkdir -p docs/releases/"$VERSION"/testing
             # Map reports to versioned release path
             cp artifacts/tests/ut-reports/ut-report.html docs/releases/"$VERSION"/testing/ut.html
             cp artifacts/tests/st-reports/st-report.html docs/releases/"$VERSION"/testing/st.html
             cp artifacts/tests/e2e-reports/e2e-report.html docs/releases/"$VERSION"/testing/e2e.html
           fi
           # Also keep 'latest' docs/testing updated
           mkdir -p docs/testing
           cp artifacts/tests/ut-reports/ut-report.html docs/testing/ut.html
           cp artifacts/tests/st-reports/st-report.html docs/testing/st.html
           cp artifacts/tests/e2e-reports/e2e-report.html docs/testing/e2e.html

      - name: Publish Documentation
        # Placeholder for actual publication command (e.g. upload to S3, Pages, etc.)
        run: |
          echo "ðŸš€ Publishing documentation for version: ${{ steps.version.outputs.version }}"
          # Verification step to ensure artifacts were correctly placed
          ls -R docs/releases || echo "No versioned releases found"
          ls -R docs/testing
