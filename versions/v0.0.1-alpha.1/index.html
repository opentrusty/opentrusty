
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Rules - OpenTrusty Docs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/redoc/bundles/redoc.standalone.js"></script>
    <script>
        var API_MODE = "false" === "true";
        var basePath = API_MODE ? ".." : "."; 
    </script>
    <style>
        :root {
            --primary: #059669; /* Emerald 600 - Reliable Tech */
            --primary-dark: #065F46; /* Logo Color - Steady */
            --bg: #f8fafc; /* Content BG - Slate 50 */
            --sidebar-bg: #041e1a; /* Very Deep Emerald - Tech/Steady */
            --text: #0f172a; /* Slate 900 */
            --text-muted: #64748b; /* Slate 500 */
            --sidebar-text: #f0fdf4; /* Emerald 50 */
            --sidebar-text-muted: #94a3b8;
            --border: rgba(6, 95, 70, 0.1);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(255,255,255,0.05);
            padding: 2.5rem 2rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            color: var(--sidebar-text);
        }
        .logo {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem;
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #fff;
            text-decoration: none;
            font-weight: 700;
        }
        .logo svg { flex-shrink: 0; }
        
        .nav-section { margin-bottom: 2rem; }
        .nav-title {
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.1rem;
            color: var(--sidebar-text-muted);
            margin-bottom: 1rem;
            font-weight: 700;
        }
        .nav-link {
            display: block;
            padding: 0.6rem 0;
            color: var(--sidebar-text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 2px solid transparent;
            padding-left: 0;
        }
        .nav-link:hover { 
            color: #fff; 
            padding-left: 0.5rem;
        }
        .nav-link.active { 
            color: var(--primary); 
            font-weight: 600; 
            border-left: 2px solid var(--primary);
            padding-left: 0.75rem;
        }

        .content-wrapper {
            margin-left: 300px;
            flex: 1;
            padding: 5rem 6rem;
            max-width: 1200px;
            min-height: 100vh;
        }
        .markdown-body { 
            line-height: 1.8; 
            font-size: 1.05rem;
            color: #334155;
        }
        .markdown-body h1 { 
            font-family: 'Montserrat', sans-serif; 
            margin-bottom: 2.5rem; 
            color: var(--primary-dark);
            font-weight: 700;
            font-size: 2.5rem;
            letter-spacing: -0.02em;
        }
        .markdown-body h2 {
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin-top: 3rem;
            color: var(--primary-dark);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }
        .markdown-body p { margin-bottom: 1.5rem; }
        .markdown-body pre { 
            background: #0f172a; 
            padding: 1.5rem; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            overflow-x: auto;
            color: #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }
        .markdown-body code {
            background: rgba(5, 150, 105, 0.05);
            color: var(--primary-dark);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .markdown-body pre code {
            background: transparent;
            color: inherit;
            padding: 0;
        }
        
        .version-selector {
            margin-top: auto;
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        select {
            background: rgba(255,255,255,0.05);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 0.6rem;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 0.85rem;
            appearance: none;
            outline: none;
        }
        select:hover {
            background: rgba(255,255,255,0.08);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="/" class="logo" onclick="event.preventDefault(); window.location.href=basePath + '/index.html'">
            <svg width="28" height="28" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg">
                <rect width="90" height="90" rx="20" fill="#065F46" />
                <path d="M15,25 H75 V40 H53 V70 H37 V40 H15 Z" fill="white" />
                <rect x="37" y="73" width="16" height="4" rx="1" fill="white" opacity="0.6" />
            </svg>
            OpenTrusty
        </a>
        <nav><div class="nav-section"><div class="nav-title">Architecture</div><a href="docs_architecture_architecture-rules.html" class="nav-link active">Architecture Rules</a><a href="docs_architecture_domain-model.html" class="nav-link ">Domain Model</a><a href="docs_architecture_runtime-assumptions.html" class="nav-link ">Runtime Assumptions</a><a href="docs_architecture_docs-publication.html" class="nav-link ">Docs Publication</a></div><div class="nav-section"><div class="nav-title">Protocols</div><a href="docs_domain_identity-model.html" class="nav-link ">Identity Model</a><a href="docs_architecture_protocol-boundary.html" class="nav-link ">Protocol Boundary</a><a href="docs_architecture_protocol-error-model.html" class="nav-link ">Error Model</a></div><div class="nav-section"><div class="nav-title">Security</div><a href="docs_security_threat-model.html" class="nav-link ">Threat Model</a><a href="docs_security_security-assumptions.html" class="nav-link ">Security Assumptions</a></div><div class="nav-section"><div class="nav-title">Deployment</div><a href="docs_fundamentals_deployment-philosophy.html" class="nav-link ">Deployment Philosophy</a><a href="docs_fundamentals_storage-model.html" class="nav-link ">Storage Model</a><a href="docs_deployment_OPERATIONS.html" class="nav-link ">Operations Guide</a><a href="docs_operations_bootstrap.html" class="nav-link ">Operations Manual</a><a href="deploy_systemd_README.html" class="nav-link ">Systemd Guide</a></div><div class="nav-section"><div class="nav-title">Roadmap</div><a href="docs_roadmap_evolution-roadmap.html" class="nav-link ">Evolution Roadmap</a><a href="docs_roadmap_tech-debt-strategy.html" class="nav-link ">Tech Debt Strategy</a></div><div class="nav-section"><div class="nav-title">API</div><a href="api/index.html" class="nav-link ">Interactive Reference</a></div><div class="nav-section"><div class="nav-title">Testing & Quality</div><a href="testing/ut.html" class="nav-link ">Unit Test Report</a><a href="testing/st.html" class="nav-link ">System Test Report</a><a href="testing/e2e.html" class="nav-link ">E2E Test Report</a><a href="docs_testing_test-annotation-standard.html" class="nav-link ">Annotation Standard</a></div></nav>
        <div class="version-selector">
            <div class="nav-title">Release Version</div>
            <select id="v-select" onchange="window.location.href=this.value"><option value="/versions/v0.0.1-alpha.1/" selected>v0.0.1-alpha.1</option></select>
        </div>
    </div>
    <main class="content-wrapper">
        <div id="content" class="markdown-body"></div>
    </main>
    <script id="md-content" type="text/template"># OpenTrusty Architecture Rules

This document outlines the normative architectural rules for the OpenTrusty project. These rules represent the "constitution" of the system and MUST be followed by all contributors. Failure to adhere to these rules constitutes a rejection criteria for any code change.

## 1. Identity

- **1.1. Persistence**: An **Identity** MUST serve as a persistent, unique representation of an actor within a **Tenant**. It MUST be distinct from the authentication credentials used to verify it.
- **1.2. Decoupling**: An Identity MUST NOT be owned by or coupled to a specific Application (`OAuthClient`). Identities are owned by the **Tenant**.
- **1.3. Uniqueness**: Identity identifiers (e.g., ID, Email) MUST be unique within the scope of their **Tenant**.
- **1.4. Lifecycle**: Identity lifecycle (Creation, Deactivation) MUST be independent of Application lifecycle. Deleting an Application MUST NOT delete its users.

## 2. Tenant

- **2.1. Isolation**: The **Tenant** MUST be the primary security boundary. All data (Users, Sessions, Tokens, configuration) MUST be scoped to a specific Tenant.
- **2.2. Enforcement**: Multi-tenancy MUST be enforced at the persistence layer (Row-Level Security or mandatory `tenant_id` columns). It MUST NOT be a purely logical application-layer filter.
- **2.3. No Cross-Talk**: Data from one Tenant MUST NOT represent, reference, or leak into another Tenant under any circumstance.
- **2.4. Identifier Standards**: 
    - **Format**: All `tenant_id` identifiers MUST be generated by the system as **UUID v7** (RFC 9562).
    - **Canonical Representation**: They MUST be stored and exposed in the canonical 8-4-4-4-12 string format.
    - **Integritiy**: Identifiers MUST NOT be hashed, shortened, or transformed. They MUST be system-generated and immutable once the Tenant is created.
- **2.5. Governance**: Tenant creation is a privileged **Platform-level** administrative action. It MUST be restricted to actors with explicit Platform-scope authorization.

## 3. Protocol (OAuth2 / OIDC)

- **3.1. Standardization**: Authentication MUST be implemented exclusively via standard **OAuth2** and **OpenID Connect** flows. Proprietary login APIs or "magic links" outside these standards SHOULD be avoided unless strictly necessary for bootstrapping.
- **3.2. Strict Compliance**: Implementation MUST adhere strictly to RFC specifications (e.g., exact string matching for `redirect_uri`).
- **3.3. Client Secrets**: `client_secret` MUST NOT be passed in URL parameters. It MUST NOT be logged in plain text. It MUST be stored using cryptographic hashing.
- **3.4. Token Scope**: Access Tokens MUST be scoped to the specific Tenant and Permissions requested. They MUST NOT grant global super-admin privileges unless explicitly scoped for system administration.

## 4. Authorization

- **4.1. Source of Truth**: The Identity Provider (OpenTrusty) MUST serve as the Source of Truth for *assignments* (Who has What Role).
- **4.2. Enforcement point**: The Resource Server (Application) MUST serve as the Point of Enforcement (Is this Role allowed to do X?). The IdP MUST NOT encode granular application-specific permission logic (e.g., "can_click_blue_button").
- **4.3. Reusability**: Roles associated with a Tenant (e.g., "Employee", "Manager") MUST be reusable across multiple Applications. They MUST NOT be hard-coded to a single `OAuthClient`.

## 5. Security

- **5.1. Session Management**: Primary user sessions (Browser Login) MUST be **Stateful** (Database-backed). Stateless tokens (JWT) MUST NOT be used for primary session management due to revocation complexity.
- **5.2. Cryptography**: 
    - Passwords MUST be hashed using **Argon2id**.
    - Weak algorithms (MD5, SHA1, unchecked bcrypt) MUST NOT be used.
- **5.3. Cookies**: All authentication cookies MUST be marked `HttpOnly`, `Secure`, and `SameSite=Lax` (or `Strict`).
- **5.4. Secrets Management**: Secrets (API Keys, Client Secrets, Private Keys) MUST be encrypted at rest or hashed. They MUST NEVER be committed to version control.

## 6. Observability

- **6.1. Structured Logging**: All logs MUST be structured (JSON/Key-Value). Unstructured text logs are forbidden.
- **6.2. Audit Trails**: All security-critical events (Login Success/Failure, Token Issuance, Password Change, Role Assignment) MUST be emitted to the Audit Log.
- **6.3. Audit Context**: Audit events MUST include the **Who** (ActorID), **Where** (TenantID, IP Address), **When** (Timestamp), and **What** (Action/Resource).
- **6.4. Privacy**: Personally Identifiable Information (PII) and Secrets (Passwords, Tokens) MUST be redacted or masked in all logs.

## 7. Development Practices

- **7.1. Clean Architecture**: Business logic MUST reside in the Domain layer (`internal/{domain}`). It MUST NOT leak into the Transport layer (HTTP Handlers).
- **7.2. Dependencies**: The project SHOULD favor the Go Standard Library. External dependencies MUST be justified by significant complexity reduction or security necessity.

## 8. Docs Governance

OpenTrusty documentation is classified into three tiers to ensure clarity of commitment and professional release management:

### 1. Versioned Contract Docs
Documentation that defines the behavior, security properties, and integration contracts of a specific release. Permanent and versioned alongside the code.
- **Location**: `docs/api/`, `docs/architecture/`, `docs/security/`, `docs/fundamentals/`, `docs/domain/`, `docs/deployment/`, `docs/audit/`, `docs/operations/`.
- **Policy**: Must be published per release. Any change to these requires a corresponding logic verification or conscious architectural decision.

### 2. Governance Docs
Documents defining the "rules of the game" and project management.
- **Location**: `docs/governance/`, `GOVERNANCE.md`, `CONTRIBUTING.md`.
- **Policy**: "Latest Only" - reflects current project state and policies regardless of binary version.

### 3. Internal / Historical Docs
Working documents, internal plans, and historical context that are not part of the public product.
- **Location**: `docs/_internal/`.
- **Policy**: Never published to the public documentation site. Used for developer context and audit trails of decision-making.
</script>
    <script>
        var raw = document.getElementById('md-content').textContent;
        if (raw && raw.trim().length > 0) {
            document.getElementById('content').innerHTML = marked.parse(raw);
        }
        if (API_MODE) {
            var specPath = basePath + '/openapi.json';
            var contentRoot = document.getElementById('content');
            
            Redoc.init(specPath, {
                expandResponses: '200,201',
                requiredPropsFirst: true,
                showExtensions: true,
                scrollYOffset: 0,
                hideDownloadButton: false,
                theme: {
                    colors: {
                        primary: { main: '#059669' },
                        text: { primary: '#334155' }
                    },
                    typography: {
                        fontFamily: 'Inter, sans-serif',
                        headings: {
                            fontFamily: 'Montserrat, sans-serif'
                        }
                    },
                    rightPanel: {
                        backgroundColor: '#0f172a'
                    }
                }
            }, contentRoot);
            
            var wrapper = document.querySelector('.content-wrapper');
            wrapper.style.padding = '0';
            wrapper.style.maxWidth = 'none';
            wrapper.style.marginLeft = '300px';
            wrapper.style.backgroundColor = '#ffffff';
        }
    </script>
</body>
</html>
