# docker-compose.test.yml
# Dedicated environment for E2E tests

services:
  opentrusty_test:
    build:
      context: ../../../
      dockerfile: deploy/docker/Dockerfile
    environment:
      - DB_HOST=postgres_test
      - DB_PORT=5432
      - DB_USER=opentrusty
      - DB_PASSWORD=opentrusty
      - DB_NAME=opentrusty_test
      - DB_SSLMODE=disable
      - ISSUER=http://opentrusty_test:8080
      - LOG_LEVEL=debug
      - ADDR=:8080
    ports:
      - "8080:8080"
    depends_on:
      postgres_test:
        condition: service_healthy
    networks:
      - e2e-net

  postgres_test:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=opentrusty
      - POSTGRES_PASSWORD=opentrusty
      - POSTGRES_DB=opentrusty_test
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U opentrusty -d opentrusty_test" ]
      interval: 3s
      timeout: 3s
      retries: 10
    networks:
      - e2e-net

networks:
  e2e-net:
    driver: bridge
